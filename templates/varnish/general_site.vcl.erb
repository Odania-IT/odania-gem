vcl 4.0;
# generated varnish config: <%= ENVIRONMENT %>
# local test: <%= LOCAL_TEST_MODE ? 'ENABLED' : 'DISABLED' %>

sub vcl_recv {
	std.log("pre varnish log info _general:" + req.http.host);

	<% %w(direct dynamic).each do |type| %>
		<% general_subdomain[type].each_pair do |url, page| %>
			if (req.url ~ "^<%= prepare_url url %>") {
				std.log("general page identified Page:'<%= url %>':" + req.url);

				<% if 'direct'.eql? type %>
				set req.backend_hint = <%= page.director %>.backend();
				<% unless page.plugin_url.nil? %>set req.url = "<%= page.plugin_url %>";<% end %>
				<% else %>
				set req.backend_hint = core_backend_director.backend();
				set req.url = "/template/page?req_url=" + req.url + "&req_host=" + req.http.host + "<%= template_url_for(domain, page) %>";
				<% end %>

				return (hash);
			}
		<% end %>
	<% end %>

	<% general_subdomain.get_redirects.each_pair do |src, target| %>
		if (req.url ~ "<%= src %>") {
			std.log("general redirect identified src:'<%= src %>':" + req.url);
			set req.http.Location = "<%= target %>";
			return (synth(750, "Permanently moved"));
		}
	<% end %>
}
