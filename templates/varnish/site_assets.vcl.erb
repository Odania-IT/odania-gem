<%
is_first = true
%>
vcl 4.0;
# generated varnish config: <%= ENVIRONMENT %>

sub vcl_recv {
	<% assets.each_pair do |asset_domain, subdomain| %>
		<%= is_first ? '' : 'else ' %>if (req.http.host ~ "^<%= asset_domain %>$") {
			std.log("subdomain identified assets '<%= asset_domain %>':" + req.http.host + " url: " + req.url );

			<% subdomain.assets.each_pair do |src, page| %>
				if (req.url ~ "^<%= src %>") {
					std.log("page identified assets '<%= asset_domain %>' Page:'<%= src %>':" + req.url);

					set req.backend_hint = <%= page.director %>.backend();
					<% unless page.plugin_url.nil? %>set req.url = "<%= page.plugin_url %>";<% end %>
				}
			<% end %>

		}
		<% is_first = false %>
	<% end %>
}
